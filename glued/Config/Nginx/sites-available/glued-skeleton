##
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#


include snippets/glued-expires.conf;
underscores_in_headers on;

server {
	expires $expires;
	include snippets/glued-gzip.conf;
	include snippets/glued-headers.conf;

	# Snakeoil SSL setup (dev only - use a tls terminating proxy)
	# Setup according to https://ssl-config.mozilla.org/
	# TODO Secure against breach according to
	# https://crashtest-security.com/prevent-breach-attacks/

	listen 8001 ssl http2 default_server;
	listen [::]:8001 ssl http2 default_server;
	ssl_protocols TLSv1.3;
	ssl_prefer_server_ciphers off;
	include snippets/snakeoil.conf;

	root /var/www/html/glued-skeleton/public;

	# Add index.php to the list if you are using PHP
	index index.php index.html index.htm index.nginx-debian.html;

	#server_name _;
	server_name 10.146.149.186;




	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		#try_files $uri $uri/ =404;
		try_files $uri $uri/ /index.php$is_args$args;
	}


        # Auth test location before php match
        location /api/core/auth/test/ {
		auth_request     /backend/auth;
		auth_request_set $auth_status $upstream_status;
		try_files $uri $uri/ /index.php$is_args$args;
        }


	# pass PHP scripts to FastCGI server
	location ~ \.php$ {
		#proxy_pass_header  Authorization;
		#proxy_set_header Authorization $http_authorization;

		fastcgi_pass_request_headers on;
		fastcgi_pass_header Authorization;
                fastcgi_param HTTP_AUTHORIZATION $http_authorization;
		fastcgi_param HTTP_X-REQUEST_ID $request_id;
		fastcgi_param HTTP_X-REAL-IP $remote_addr;
		fastcgi_param HTTP_X-FORWARDED-FOR $proxy_add_x_forwarded_for;

		include snippets/fastcgi-php.conf;
		fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
	}


        location = /backend/auth {
            #internal;
            proxy_pass                 https://127.0.0.1:8001/api/core/auth/enforce/v1;
            proxy_set_header Host      $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass_request_body    off;
            proxy_set_header           Content-Length "";
            proxy_set_header           X-Original-URI $request_uri;
            proxy_ssl_protocols        TLSv1.3;
        }


        location = /backend/py {
            #internal;
            proxy_pass              http://127.0.0.1:9000/;
            proxy_set_header Host      $host;
            proxy_set_header X-Real-IP $remote_addr;
#            proxy_pass_request_body off;
#            proxy_set_header        Content-Length "";
#            proxy_set_header        X-Original-URI $request_uri;
#            proxy_ssl_protocols TLSv1.3;
        }

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	location ~ /\.ht {
		deny all;
	}
}

